<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>백석대 성경고사</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: 'Noto Sans KR', sans-serif; background-color: #e6f0ff; margin:0; padding:20px; text-align:center;}
  h1 { color:#002366; font-size:2em; margin-bottom:10px;}
  button { margin:5px; padding:10px 16px; font-size:1em; border:none; border-radius:10px; cursor:pointer; background-color:#0056d6; color:white; transition:0.3s;}
  button:hover { background-color:#003c9d;}
  #question-container { margin-top:20px; padding:20px; background:white; border-radius:15px; box-shadow:0 4px 8px rgba(0,0,0,0.1); display:none; max-width:600px; margin-left:auto; margin-right:auto;}
  .timer { font-size:1.2em; color:#d9534f; font-weight:bold; margin-bottom:10px;}
  #result { margin-top:10px; font-weight:bold;}
  @media(max-width:600px){ button{width:80%; margin:5px 0; }}
</style>
</head>
<body>

<h1>📖 백석대 성경고사</h1>

<div id="home-screen">
  <button id="practice-btn">연습문제 시작</button>
  <button id="mock-btn">모의고사 시작</button>
</div>

<div id="range-selection" style="display:none;">
  <h2>연습문제 범위 선택</h2>
  <div id="range-buttons"></div>
  <button id="range-back">⬅ 뒤로</button>
</div>

<button id="home-btn" style="display:none;">🏠 홈으로</button>

<div id="question-container">
  <div id="timer" class="timer"></div>
  <h2 id="question"></h2>
  <div id="options"></div>
  <button id="prev-btn" style="display:none;">⬅ 이전</button>
  <button id="next-btn" style="display:none;">다음 ➡</button>
  <button id="submit-btn" style="display:none;">제출하기</button>
  <div id="result"></div>
</div>

<script>
let questions=[], currentIndex=0, mode='', answers=[], timer, timeLeft=0;

// 성경 범위
const ranges = [
  {name:"고린도전서", file:"1.txt"},
  {name:"고린도후서", file:"2.txt"},
  {name:"갈라디아서", file:"3.txt"},
  {name:"에베소서", file:"4.txt"},
  {name:"빌립보서", file:"5.txt"},
  {name:"골로새서", file:"6.txt"},
  {name:"데살로니가전서", file:"7.txt"},
  {name:"데살로니가후서", file:"8.txt"},
  {name:"디모데전서", file:"9.txt"},
  {name:"디모데후서", file:"10.txt"},
  {name:"디도서", file:"11.txt"},
  {name:"빌레몬서", file:"12.txt"},
  {name:"히브리서", file:"13.txt"},
  {name:"야고보서", file:"14.txt"},
  {name:"베드로전서", file:"15.txt"},
  {name:"베드로후서", file:"16.txt"},
  {name:"요한일서", file:"17.txt"},
  {name:"요한이서", file:"18.txt"},
  {name:"요한삼서", file:"19.txt"},
  {name:"유다서", file:"20.txt"},
  {name:"요한계시록", file:"21.txt"},
];

// 버튼 이벤트
document.getElementById("practice-btn").onclick = ()=> showRangeSelection();
document.getElementById("mock-btn").onclick = ()=> startMode("mock");
document.getElementById("home-btn").onclick = goHome;
document.getElementById("next-btn").onclick = nextQuestion;
document.getElementById("prev-btn").onclick = prevQuestion;
document.getElementById("submit-btn").onclick = showMockResult;
document.getElementById("range-back").onclick = ()=>{document.getElementById("range-selection").style.display="none";document.getElementById("home-screen").style.display="block";}

// 범위 선택 UI
function showRangeSelection(){
  document.getElementById("home-screen").style.display="none";
  const container = document.getElementById("range-buttons");
  container.innerHTML="";
  ranges.forEach((r,i)=>{
    const btn = document.createElement("button");
    btn.innerText=r.name;
    btn.onclick = ()=> startMode("practice", r);
    container.appendChild(btn);
  });
  document.getElementById("range-selection").style.display="block";
}

// 시작
async function startMode(selectedMode, range=null){
  mode=selectedMode;
  document.getElementById("home-btn").style.display="block";
  document.getElementById("home-screen").style.display="none";
  document.getElementById("range-selection").style.display="none";
  document.getElementById("question-container").style.display="block";
  answers=[];
  currentIndex=0;

  if(mode==="practice" && range){
    questions = await loadQuestions([range.file]);
  } else if(mode==="mock"){
    const allQuestions = await loadQuestions(ranges.map(r=>r.file));
    let selected=[];
    ranges.forEach(r=>{
      const rqs = allQuestions.filter(q=>q.range===r.name);
      if(rqs.length>0){
        const count = Math.min(rqs.length, Math.floor(Math.random()*5)+1);
        selected.push(...shuffleArray(rqs).slice(0,count));
      }
    });
    // 총 50문제 맞추기
    while(selected.length<50){
      const remaining = allQuestions.filter(q=>!selected.includes(q));
      if(remaining.length===0) break;
      selected.push(remaining[Math.floor(Math.random()*remaining.length)]);
    }
    questions = shuffleArray(selected).slice(0,50);
    startTimer(3000); // 50분
    document.getElementById("prev-btn").style.display="inline";
    document.getElementById("submit-btn").style.display="inline";
  }
  showQuestion();
}

// 문제 불러오기
async function loadQuestions(files){
  let loaded=[];
  for(const f of files){
    try{
      const res = await fetch('questions/${f}`);
      if(res.ok){
        const txt = await res.text();
        const qs = parseQuestions(txt, f);
        loaded.push(...qs);
      }
    }catch(e){console.log(e);}
  }
  return loaded;
}

// 문제 파싱
function parseQuestions(text, rangeName){
  const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
  const qs=[];
  let current={options:[]};
  lines.forEach(line=>{
    if(line.startsWith("답:")){
      current.answer = parseInt(line.replace("답:","").trim())-1;
      current.range = rangeName;
      qs.push(current);
      current={options:[]};
    } else if(!current.question){
      current.question=line;
    } else {
      current.options.push(line.replace(/^\d번:\s*/,""));
    }
  });
  return qs;
}

// ✅ 문제 표시 함수 (연습모드, 모의고사 공통)
function showQuestion(question) {
  const questionContainer = document.getElementById("question-container");
  const correctAnswers = question.answer
    .toString()
    .split(",")
    .map(a => a.trim()); // ["2","6"]

  questionContainer.innerHTML = `
    <h3>${question.number}. ${question.text}</h3>
    ${question.options
      .map(
        (opt, i) => `
        <button class="option-btn" onclick="selectAnswer(${i + 1})">
          ${i + 1}. ${opt}
        </button>`
      )
      .join("")}
  `;
  document.getElementById("result").innerHTML = "";
}

// ✅ 답 선택 (단일 + 다중 정답 모두 처리)
function selectAnswer(i) {
  const q = questions[currentIndex];
  const correctAnswers = q.answer
    .toString()
    .split(",")
    .map(a => a.trim()); // ["2", "6"] 또는 ["3"]

  if (!answers[currentIndex]) answers[currentIndex] = [];

  const optionButtons = document.querySelectorAll(".option-btn");

  // 다중 정답일 경우 여러 개 선택 허용
  if (correctAnswers.length > 1) {
    const idx = answers[currentIndex].indexOf(i);
    if (idx > -1) {
      answers[currentIndex].splice(idx, 1); // 이미 선택 → 해제
      optionButtons[i - 1].classList.remove("selected");
    } else {
      answers[currentIndex].push(i); // 선택 추가
      optionButtons[i - 1].classList.add("selected");
    }
  } else {
    // 단일 정답 (기존 방식)
    answers[currentIndex] = [i];
    optionButtons.forEach(btn => btn.classList.remove("selected"));
    optionButtons[i - 1].classList.add("selected");
  }

  // 연습모드일 경우 즉시 채점
  if (mode === "practice") {
    const selected = answers[currentIndex].map(String);
    const isCorrect =
      selected.length === correctAnswers.length &&
      selected.every(a => correctAnswers.includes(a));

    if (isCorrect) {
      document.getElementById("result").innerHTML =
        `✅ 정답입니다!<br>정답: ${correctAnswers
          .map(n => q.options[parseInt(n) - 1])
          .join(", ")}`;
    } else {
      document.getElementById("result").innerHTML =
        `❌ 오답입니다.<br>정답: ${correctAnswers
          .map(n => q.options[parseInt(n) - 1])
          .join(", ")}`;
    }
  }
}

// 이전/다음
function nextQuestion(){
  if(currentIndex<questions.length-1){ currentIndex++; showQuestion(); }
}
function prevQuestion(){
  if(currentIndex>0){ currentIndex--; showQuestion(); }
}

// 모의고사 결과
function showMockResult() {
  clearInterval(timer);
  let score = 0;
  let html = "<h3>결과</h3>";

  questions.forEach((q, i) => {
    const correctIndex = q.answer; // 정답 인덱스
    const userIndex = answers[i];   // 사용자가 선택한 인덱스
    const isCorrect = userIndex === correctIndex;
    if (isCorrect) score++;

    html += `
      <div style="margin-bottom:15px; padding:10px; border-bottom:1px solid #ccc;">
        <p><strong>문제 ${i + 1}:</strong> ${q.question}</p>
        <p>선택: ${userIndex !== undefined ? q.options[userIndex] : "-"} ${isCorrect ? "✅" : "❌"}</p>
        <p>정답: ${q.options[correctIndex]}</p>
        ${q.explanation ? `<p>해설: ${q.explanation}</p>` : ""}
      </div>
    `;
  });

  html = `<h2>총점: ${Math.round(score / questions.length * 100)}</h2>` + html;

  document.getElementById("question").innerHTML = html;
  document.getElementById("options").innerHTML = "";
  document.getElementById("prev-btn").style.display = "none";
  document.getElementById("next-btn").style.display = "none";
  document.getElementById("submit-btn").style.display = "none";
  document.getElementById("timer").innerText = "";
}
// 타이머
function startTimer(seconds){
  timeLeft=seconds;
  timer=setInterval(()=>{
    const min=Math.floor(timeLeft/60);
    const sec=timeLeft%60;
    document.getElementById("timer").innerText=`⏰ 남은 시간: ${min}분 ${sec<10?"0"+sec:sec}초`;
    if(timeLeft--<=0){ clearInterval(timer); showMockResult(); }
  },1000);
}

// 홈 이동
function goHome(){
  clearInterval(timer);
  document.getElementById("home-screen").style.display="block";
  document.getElementById("range-selection").style.display="none";
  document.getElementById("question-container").style.display="none";
  document.getElementById("home-btn").style.display="none";
  answers=[]; currentIndex=0; questions=[];
}

// 배열 섞기
function shuffleArray(arr){ return arr.sort(()=>Math.random()-0.5);}
</script>

</body>
</html>
