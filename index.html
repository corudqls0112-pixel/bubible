<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>성경고사 앱</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      background: #f9fafb;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background: #2563eb;
      color: white;
      text-align: center;
      padding: 1rem;
      font-size: 1.5rem;
      font-weight: bold;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      background: #1e3a8a;
      padding: 0.5rem;
    }
    nav button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
    }
    nav button:hover {
      background: #60a5fa;
    }
    .container {
      max-width: 800px;
      margin: 1.5rem auto;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .question { margin-bottom: 1rem; }
    .option {
      margin: 0.25rem 0;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
    }
    .option:hover { background: #f0f9ff; }
    .correct { background: #bbf7d0; }
    .wrong { background: #fecaca; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      text-align: center;
      padding: 0.5rem;
    }
    th {
      background: #f1f5f9;
    }
    .hidden { display: none; }
    .btn {
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn:hover { background: #1d4ed8; }
  </style>
</head>
<body>
  <header>📖 성경고사 앱</header>

  <nav>
    <button onclick="showPage('practice')">연습문제</button>
    <button onclick="showPage('mock')">모의고사</button>
    <button onclick="showPage('manage')">문제 관리</button>
    <button onclick="showPage('stats')">통계</button>
  </nav>

  <div class="container" id="content"></div>

  <script>
    const STORAGE_KEY = 'bibleQuestions';
    const RESULT_KEY = 'examResults';
    const QUESTION_URL = 'questions.json'; // ✅ GitHub에서 직접 관리할 JSON 파일

    async function loadQuestions() {
      // 1️⃣ GitHub pages에서 questions.json을 불러오기 시도
      try {
        const res = await fetch(QUESTION_URL);
        if (res.ok) {
          const data = await res.json();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          return data;
        }
      } catch (e) {
        console.warn("questions.json 불러오기 실패, 로컬 데이터 사용");
      }

      // 2️⃣ 로컬 스토리지 백업
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }

    function saveQuestions(qs) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(qs));
    }

    function showPage(page) {
      const container = document.getElementById('content');
      container.innerHTML = '';

      if (page === 'practice') renderPractice();
      else if (page === 'mock') renderMock();
      else if (page === 'manage') renderManage();
      else if (page === 'stats') renderStats();
    }

    // ✅ 연습문제
    async function renderPractice() {
      const container = document.getElementById('content');
      const questions = await loadQuestions();
      if (!questions.length) return container.innerHTML = "<p>문제를 추가해주세요.</p>";

      container.innerHTML = '<h2>📝 연습문제</h2>';
      questions.forEach((q, idx) => {
        const div = document.createElement('div');
        div.className = 'question';
        div.innerHTML = `<p><b>${idx + 1}. ${q.q}</b></p>`;
        q.options.forEach((opt, i) => {
          const btn = document.createElement('div');
          btn.className = 'option';
          btn.textContent = opt;
          btn.onclick = () => {
            if (i === q.answer) btn.classList.add('correct');
            else btn.classList.add('wrong');
          };
          div.appendChild(btn);
        });
        container.appendChild(div);
      });
    }

    // ✅ 모의고사 (랜덤 문제)
    async function renderMock() {
      const container = document.getElementById('content');
      let questions = await loadQuestions();
      if (!questions.length) return container.innerHTML = "<p>문제가 없습니다.</p>";

      // 🔀 문제 순서 랜덤화
      questions = questions.sort(() => Math.random() - 0.5);
      let score = 0, current = 0;

      const renderQuestion = () => {
        container.innerHTML = `<h2>📚 모의고사 (${current + 1}/${questions.length})</h2>`;
        const q = questions[current];
        const div = document.createElement('div');
        div.innerHTML = `<p><b>${q.q}</b></p>`;
        q.options.forEach((opt, i) => {
          const btn = document.createElement('div');
          btn.className = 'option';
          btn.textContent = opt;
          btn.onclick = () => {
            if (i === q.answer) score++;
            current++;
            if (current < questions.length) renderQuestion();
            else showResult();
          };
          div.appendChild(btn);
        });
        container.appendChild(div);
      };

      const showResult = () => {
        const percent = (score / questions.length * 100).toFixed(1);
        container.innerHTML = `<h2>결과: ${score}/${questions.length}</h2>
          <p>점수: ${percent}%</p>
          <button class="btn" onclick="showPage('stats')">통계 보기</button>`;
        saveResult(score, questions.length);
      };

      renderQuestion();
    }

    // ✅ 문제 관리
    async function renderManage() {
      const container = document.getElementById('content');
      const questions = await loadQuestions();
      container.innerHTML = `
        <h2>⚙ 문제 관리</h2>
        <div>
          <input id="qText" placeholder="문제" style="width:100%;padding:0.5rem;margin-bottom:0.5rem;">
          <input id="opt1" placeholder="보기 1" style="width:48%;margin-right:2%;">
          <input id="opt2" placeholder="보기 2" style="width:48%;">
          <input id="opt3" placeholder="보기 3" style="width:48%;margin-right:2%;">
          <input id="opt4" placeholder="보기 4" style="width:48%;">
          <input id="ans" type="number" min="1" max="4" placeholder="정답 번호(1~4)" style="width:100%;margin-top:0.5rem;">
          <button class="btn" onclick="addQuestion()">문제 추가</button>
        </div>
        <hr>
        <h3>현재 등록된 문제 (${questions.length}개)</h3>
        <ul>${questions.map((q,i)=>`<li>${i+1}. ${q.q}</li>`).join('')}</ul>
        <p style="color:gray;font-size:0.9rem;">※ GitHub에 올린 questions.json 파일도 수정 가능</p>
      `;
    }

    function addQuestion() {
      const q = document.getElementById('qText').value;
      const opts = [opt1.value, opt2.value, opt3.value, opt4.value];
      const ans = parseInt(document.getElementById('ans').value) - 1;
      if (!q || opts.some(o=>!o) || isNaN(ans)) return alert("모든 칸을 채워주세요!");

      const qs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      qs.push({ q, options: opts, answer: ans });
      saveQuestions(qs);
      alert("문제가 추가되었습니다!");
      showPage('manage');
    }

    // ✅ 통계 (차트 포함)
    function renderStats() {
      const records = JSON.parse(localStorage.getItem(RESULT_KEY) || '[]');
      const container = document.getElementById('content');
      container.innerHTML = '<h2>📊 통계</h2>';

      if (records.length === 0) {
        container.innerHTML += '<p>아직 시험 기록이 없습니다.</p>';
        return;
      }

      const avg = (records.reduce((a,b)=>a+b.percentage,0)/records.length).toFixed(1);
      container.innerHTML += `<p>평균 점수: <b>${avg}%</b></p><canvas id="scoreChart"></canvas>`;

      const lastFive = records.slice(-5);
      const ctx = document.getElementById('scoreChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: lastFive.map(r => new Date(r.date).toLocaleDateString()),
          datasets: [{
            label: '최근 점수',
            data: lastFive.map(r => r.percentage),
            backgroundColor: '#60a5fa'
          }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }

    function saveResult(score, total) {
      const record = {
        date: new Date().toISOString(),
        score,
        total,
        percentage: Math.round((score/total)*100)
      };
      const existing = JSON.parse(localStorage.getItem(RESULT_KEY) || '[]');
      localStorage.setItem(RESULT_KEY, JSON.stringify([...existing, record]));
    }

    showPage('practice');
  </script>
</body>
</html>
